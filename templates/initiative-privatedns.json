{
  "$schema": "https://schema.management.azure.com/schemas/2019-08-01/managementGroupDeploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "_generator": {
      "name": "bicep",
      "version": "0.4.1124.51302",
      "templateHash": "17222269897639627881"
    }
  },
  "parameters": {
    "dnsResourceGroupName": {
      "type": "string",
      "defaultValue": "rg-prod-global-privatedns"
    },
    "networkSubId": {
      "type": "string",
      "defaultValue": "<>"
    },
    "dnsLinkedVnetId": {
      "type": "string",
      "defaultValue": "<>",
      "metadata": {
        "description": "VNet to link private DNS zones"
      }
    },
    "location": {
      "type": "string",
      "defaultValue": "eastus"
    },
    "time": {
      "type": "string",
      "defaultValue": "[utcNow()]"
    },
    "dnsZoneParameters": {
      "type": "array",
      "defaultValue": "[json('[\r\n    {\r\n      \"resource\": \"ACR\",\r\n      \"zoneName\": \"privatelink.azurecr.io\",\r\n      \"groupId\": \"registry\"\r\n    },\r\n    {\r\n      \"resource\": \"ADLS\",\r\n      \"zoneName\": \"privatelink.dfs.core.windows.net\",\r\n      \"groupId\": \"dfs\"\r\n    },\r\n    {\r\n      \"resource\": \"AKS-EastUs\",\r\n      \"zoneName\": \"privatelink.eastus.azmk8s.io\",\r\n      \"groupId\": \"management\"\r\n    },\r\n    {\r\n      \"resource\": \"AKS-WestUs\",\r\n      \"zoneName\": \"privatelink.westus.azmk8s.io\",\r\n      \"groupId\": \"management\"\r\n    },\r\n    {\r\n      \"resource\": \"AppService\",\r\n      \"zoneName\": \"privatelink.azurewebsites.net\",\r\n      \"groupId\": \"sites\"\r\n    },\r\n    {\r\n      \"resource\": \"Batch-EastUs\",\r\n      \"zoneName\": \"privatelink.eastus.batch.azure.com\",\r\n      \"groupId\": \"batchAccount\"\r\n    },\r\n    {\r\n      \"resource\": \"Batch-WestUs\",\r\n      \"zoneName\": \"privatelink.westus.batch.azure.com\",\r\n      \"groupId\": \"batchAccount\"\r\n    },\r\n    {\r\n      \"resource\": \"Blob\",\r\n      \"zoneName\": \"privatelink.blob.core.windows.net\",\r\n      \"groupId\": \"blob\"\r\n    },\r\n    {\r\n      \"resource\": \"Cosmos\",\r\n      \"zoneName\": \"privatelink.documents.azure.com\",\r\n      \"groupId\": \"sql\"\r\n    },\r\n    {\r\n      \"resource\": \"File\",\r\n      \"zoneName\": \"privatelink.file.core.windows.net\",\r\n      \"groupId\": \"file\"\r\n    },\r\n    {\r\n      \"resource\": \"FileSync\",\r\n      \"zoneName\": \"privatelink.afs.azure.net\",\r\n      \"groupId\": \"afs\"\r\n    },\r\n    {\r\n      \"resource\": \"KeyVault\",\r\n      \"zoneName\": \"privatelink.vaultcore.azure.net\",\r\n      \"groupId\": \"vault\"\r\n    },\r\n    {\r\n      \"resource\": \"MySQL\",\r\n      \"zoneName\": \"privatelink.mysql.database.azure.com\",\r\n      \"groupId\": \"mysqlServer\"\r\n    },\r\n    {\r\n      \"resource\": \"PostgreSQL\",\r\n      \"zoneName\": \"privatelink.postgres.database.azure.com\",\r\n      \"groupId\": \"postgresqlServer\"\r\n    },\r\n    {\r\n      \"resource\": \"SQL\",\r\n      \"zoneName\": \"privatelink.database.windows.net\",\r\n      \"groupId\": \"SQLServer\"\r\n    },\r\n    {\r\n      \"resource\": \"Synapse\",\r\n      \"zoneName\": \"privatelink.sql.azuresynapse.net\",\r\n      \"groupId\": \"Dev\"\r\n    }\r\n  ]')]"
    }
  },
  "variables": {
    "privateDNSPolicy": "[json('{\r\n    \"Description\": \"Deny the creation of private link DNS zones\",\r\n    \"DisplayName\": \"Deny Private Link DNS\",\r\n    \"Name\": \"Deny-PrivateLink-DNS\",\r\n    \"mode\": \"Indexed\",\r\n    \"policyRule\": {\r\n      \"if\": {\r\n        \"allOf\": [\r\n          {\r\n            \"field\": \"type\",\r\n            \"equals\": \"Microsoft.Network/privateDnsZones\"\r\n          },\r\n          {\r\n            \"field\": \"name\",\r\n            \"like\": \"privatelink*\"\r\n          }\r\n        ]\r\n      },\r\n      \"then\": {\r\n        \"effect\": \"[parameters(''effect'')]\"\r\n      }\r\n    },\r\n    \"parameters\": {\r\n      \"effect\": {\r\n        \"type\": \"String\",\r\n        \"metadata\": {\r\n          \"displayName\": \"Effect\",\r\n          \"description\": \"Enable or disable the execution of the policy\"\r\n        },\r\n        \"allowedValues\": [\r\n          \"Audit\",\r\n          \"Deny\",\r\n          \"Disabled\"\r\n        ],\r\n        \"defaultValue\": \"Deny\"\r\n      }\r\n    }\r\n  }')]",
    "nonComplianceMessage": "Private Link DNS Zones are already created: Choose \"No\" for \"Integrate with Private DNS zone\"",
    "managementGroupName": "[managementGroup().name]",
    "dnsLinkedVnetName": "[split(parameters('dnsLinkedVnetId'), '/')[8]]"
  },
  "resources": [
    {
      "type": "Microsoft.Authorization/policySetDefinitions",
      "apiVersion": "2020-09-01",
      "name": "Private-DNS-PaaS",
      "properties": {
        "copy": [
          {
            "name": "policyDefinitions",
            "count": "[length(range(0, length(parameters('dnsZoneParameters'))))]",
            "input": {
              "policyDefinitionId": "[reference(extensionResourceId(managementGroup().id, 'Microsoft.Resources/deployments', format('DNS-Policy-{0}-{1}', parameters('dnsZoneParameters')[range(0, length(parameters('dnsZoneParameters')))[range(0, length(parameters('dnsZoneParameters')))[copyIndex('policyDefinitions')]]].resource, parameters('time'))), '2020-10-01').outputs.policyId.value]",
              "policyDefinitionReferenceId": "[format('{0}-Private-DNS', parameters('dnsZoneParameters')[range(0, length(parameters('dnsZoneParameters')))[copyIndex('policyDefinitions')]].resource)]",
              "parameters": {
                "privateDnsZoneId": {
                  "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('networkSubId'), parameters('dnsResourceGroupName')), 'Microsoft.Resources/deployments', format('DNS-Zone-{0}', parameters('dnsZoneParameters')[range(0, length(parameters('dnsZoneParameters')))[range(0, length(parameters('dnsZoneParameters')))[copyIndex('policyDefinitions')]]].resource)), '2020-10-01').outputs.zoneId.value]"
                }
              }
            }
          }
        ],
        "displayName": "Create DNS record for PaaS services",
        "description": "Create DNS record for PaaS services",
        "parameters": {}
      },
      "dependsOn": [
        "dnsPolicy",
        "privateDnsZones"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2020-10-01",
      "name": "[format('PrivateDNS-ResourceGroup-{0}', parameters('time'))]",
      "subscriptionId": "[parameters('networkSubId')]",
      "location": "[deployment().location]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "[parameters('location')]"
          },
          "resourceGroupName": {
            "value": "[parameters('dnsResourceGroupName')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.4.1124.51302",
              "templateHash": "13172754692466096763"
            }
          },
          "parameters": {
            "resourceGroupName": {
              "type": "string"
            },
            "location": {
              "type": "string"
            },
            "tags": {
              "type": "object",
              "defaultValue": {}
            }
          },
          "resources": [
            {
              "type": "Microsoft.Resources/resourceGroups",
              "apiVersion": "2021-04-01",
              "name": "[parameters('resourceGroupName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]"
            }
          ],
          "outputs": {
            "resourceGroupId": {
              "type": "string",
              "value": "[subscriptionResourceId('Microsoft.Resources/resourceGroups', parameters('resourceGroupName'))]"
            }
          }
        }
      }
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2020-10-01",
      "name": "create-denyPrivateDNS-policy",
      "location": "[deployment().location]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "policyDescription": {
            "value": "[variables('privateDNSPolicy').Description]"
          },
          "policyDisplayName": {
            "value": "[variables('privateDNSPolicy').DisplayName]"
          },
          "policyName": {
            "value": "[variables('privateDNSPolicy').Name]"
          },
          "policyParameters": {
            "value": "[variables('privateDNSPolicy').parameters]"
          },
          "policyRule": {
            "value": "[variables('privateDNSPolicy').policyRule]"
          },
          "mode": {
            "value": "[variables('privateDNSPolicy').mode]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-08-01/managementGroupDeploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.4.1124.51302",
              "templateHash": "8472312362256797774"
            }
          },
          "parameters": {
            "policyName": {
              "type": "string"
            },
            "policyRule": {
              "type": "object"
            },
            "policyDescription": {
              "type": "string"
            },
            "policyDisplayName": {
              "type": "string"
            },
            "mode": {
              "type": "string",
              "defaultValue": "indexed"
            },
            "policyParameters": {
              "type": "object"
            }
          },
          "resources": [
            {
              "type": "Microsoft.Authorization/policyDefinitions",
              "apiVersion": "2020-09-01",
              "name": "[parameters('policyName')]",
              "properties": {
                "policyRule": "[parameters('policyRule')]",
                "policyType": "Custom",
                "mode": "[parameters('mode')]",
                "description": "[parameters('policyDescription')]",
                "displayName": "[parameters('policyDisplayName')]",
                "parameters": "[parameters('policyParameters')]"
              }
            }
          ],
          "outputs": {
            "policyId": {
              "type": "string",
              "value": "[extensionResourceId(managementGroup().id, 'Microsoft.Authorization/policyDefinitions', parameters('policyName'))]"
            }
          }
        }
      }
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2020-10-01",
      "name": "delay-PrivateDNS",
      "location": "[deployment().location]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-08-01/managementGroupDeploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.4.1124.51302",
              "templateHash": "1545203232704064580"
            }
          },
          "parameters": {
            "time": {
              "type": "string",
              "defaultValue": "[utcNow()]"
            }
          },
          "variables": {
            "uniqueName": "[guid(parameters('time'))]"
          },
          "resources": [
            {
              "copy": {
                "name": "delayLoop",
                "count": "[length(range(0, 10))]",
                "mode": "serial",
                "batchSize": 1
              },
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2021-04-01",
              "name": "[format('{0}-{1}', variables('uniqueName'), range(0, 10)[copyIndex()])]",
              "location": "[deployment().location]",
              "properties": {
                "mode": "Incremental",
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-08-01/managementGroupDeploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "parameters": {},
                  "resources": [],
                  "outputs": {}
                }
              }
            }
          ]
        }
      }
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2020-10-01",
      "name": "assign-deny-PrivateDNS",
      "location": "[deployment().location]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "policyAssignmentEnforcementMode": {
            "value": "Default"
          },
          "policyAssignmentName": {
            "value": "[variables('privateDNSPolicy').Name]"
          },
          "policyDefinitionId": {
            "value": "[reference(extensionResourceId(managementGroup().id, 'Microsoft.Resources/deployments', 'create-denyPrivateDNS-policy'), '2020-10-01').outputs.policyId.value]"
          },
          "policyDescription": {
            "value": "[variables('privateDNSPolicy').Description]"
          },
          "nonComplianceMessage": {
            "value": "[variables('nonComplianceMessage')]"
          },
          "policyDisplayName": {
            "value": "[variables('privateDNSPolicy').DisplayName]"
          },
          "location": {
            "value": "[parameters('location')]"
          },
          "exclusions": {
            "value": [
              "[format('/providers/Microsoft.Management/managementGroups/{0}-connectivity', variables('managementGroupName'))]"
            ]
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-08-01/managementGroupDeploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.4.1124.51302",
              "templateHash": "16387928720901184567"
            }
          },
          "parameters": {
            "policyAssignmentEnforcementMode": {
              "type": "string",
              "allowedValues": [
                "Default",
                "DoNotEnforce"
              ],
              "metadata": {
                "description": "Input will determine if the policyAssignment should be enforced or not."
              }
            },
            "policyDefinitionId": {
              "type": "string"
            },
            "policyAssignmentName": {
              "type": "string"
            },
            "policyDisplayName": {
              "type": "string"
            },
            "policyDescription": {
              "type": "string"
            },
            "policyParameters": {
              "type": "object",
              "defaultValue": {}
            },
            "exclusions": {
              "type": "array",
              "defaultValue": []
            },
            "nonComplianceMessage": {
              "type": "string"
            },
            "location": {
              "type": "string"
            }
          },
          "resources": [
            {
              "type": "Microsoft.Authorization/policyAssignments",
              "apiVersion": "2020-09-01",
              "name": "[parameters('policyAssignmentName')]",
              "identity": {
                "type": "SystemAssigned"
              },
              "location": "[parameters('location')]",
              "properties": {
                "description": "[parameters('policyDescription')]",
                "displayName": "[parameters('policyDisplayName')]",
                "policyDefinitionId": "[parameters('policyDefinitionId')]",
                "enforcementMode": "[parameters('policyAssignmentEnforcementMode')]",
                "parameters": "[parameters('policyParameters')]",
                "notScopes": "[parameters('exclusions')]",
                "nonComplianceMessages": [
                  {
                    "message": "[parameters('nonComplianceMessage')]"
                  }
                ]
              }
            }
          ],
          "outputs": {
            "policyIdentity": {
              "type": "string",
              "value": "[reference(extensionResourceId(managementGroup().id, 'Microsoft.Authorization/policyAssignments', parameters('policyAssignmentName')), '2020-09-01', 'full').identity.principalId]"
            }
          }
        }
      },
      "dependsOn": [
        "[extensionResourceId(managementGroup().id, 'Microsoft.Resources/deployments', 'delay-PrivateDNS')]",
        "[extensionResourceId(managementGroup().id, 'Microsoft.Resources/deployments', 'create-denyPrivateDNS-policy')]"
      ]
    },
    {
      "copy": {
        "name": "privateDnsZones",
        "count": "[length(range(0, length(parameters('dnsZoneParameters'))))]"
      },
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2020-10-01",
      "name": "[format('DNS-Zone-{0}', parameters('dnsZoneParameters')[range(0, length(parameters('dnsZoneParameters')))[copyIndex()]].resource)]",
      "subscriptionId": "[parameters('networkSubId')]",
      "resourceGroup": "[parameters('dnsResourceGroupName')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "dnsZone": {
            "value": "[parameters('dnsZoneParameters')[range(0, length(parameters('dnsZoneParameters')))[copyIndex()]].zoneName]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.4.1124.51302",
              "templateHash": "13965500159796501255"
            }
          },
          "parameters": {
            "dnsZone": {
              "type": "string"
            }
          },
          "resources": [
            {
              "type": "Microsoft.Network/privateDnsZones",
              "apiVersion": "2018-09-01",
              "name": "[parameters('dnsZone')]",
              "location": "global",
              "properties": {}
            }
          ],
          "outputs": {
            "zoneId": {
              "type": "string",
              "value": "[resourceId('Microsoft.Network/privateDnsZones', parameters('dnsZone'))]"
            }
          }
        }
      },
      "dependsOn": [
        "[subscriptionResourceId(parameters('networkSubId'), 'Microsoft.Resources/deployments', format('PrivateDNS-ResourceGroup-{0}', parameters('time')))]"
      ]
    },
    {
      "copy": {
        "name": "connectDns",
        "count": "[length(range(0, length(parameters('dnsZoneParameters'))))]"
      },
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2020-10-01",
      "name": "[format('DNS-Connections-{0}', parameters('dnsZoneParameters')[range(0, length(parameters('dnsZoneParameters')))[copyIndex()]].resource)]",
      "subscriptionId": "[parameters('networkSubId')]",
      "resourceGroup": "[parameters('dnsResourceGroupName')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "vnetID": {
            "value": "[parameters('dnsLinkedVnetId')]"
          },
          "connectionName": {
            "value": "[format('Connection-to-{0}', variables('dnsLinkedVnetName'))]"
          },
          "dnsZoneName": {
            "value": "[parameters('dnsZoneParameters')[range(0, length(parameters('dnsZoneParameters')))[copyIndex()]].zoneName]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.4.1124.51302",
              "templateHash": "10267279652354975775"
            }
          },
          "parameters": {
            "dnsZoneName": {
              "type": "string"
            },
            "connectionName": {
              "type": "string"
            },
            "vnetID": {
              "type": "string"
            },
            "autoReg": {
              "type": "bool",
              "defaultValue": false,
              "allowedValues": [
                true,
                false
              ]
            }
          },
          "resources": [
            {
              "type": "Microsoft.Network/privateDnsZones/virtualNetworkLinks",
              "apiVersion": "2020-06-01",
              "name": "[format('{0}/{1}', parameters('dnsZoneName'), parameters('connectionName'))]",
              "location": "global",
              "properties": {
                "virtualNetwork": {
                  "id": "[parameters('vnetID')]"
                },
                "registrationEnabled": "[parameters('autoReg')]"
              }
            }
          ]
        }
      },
      "dependsOn": [
        "privateDnsZones"
      ]
    },
    {
      "copy": {
        "name": "dnsPolicy",
        "count": "[length(range(0, length(parameters('dnsZoneParameters'))))]"
      },
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2020-10-01",
      "name": "[format('DNS-Policy-{0}-{1}', parameters('dnsZoneParameters')[range(0, length(parameters('dnsZoneParameters')))[copyIndex()]].resource, parameters('time'))]",
      "location": "[deployment().location]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "name": {
            "value": "[format('PrivateDNS-{0}', parameters('dnsZoneParameters')[range(0, length(parameters('dnsZoneParameters')))[copyIndex()]].resource)]"
          },
          "groupId": {
            "value": "[parameters('dnsZoneParameters')[range(0, length(parameters('dnsZoneParameters')))[copyIndex()]].groupId]"
          },
          "description": {
            "value": "[format('Create DNS record when {0} and private link are deployed', parameters('dnsZoneParameters')[range(0, length(parameters('dnsZoneParameters')))[copyIndex()]].resource)]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-08-01/managementGroupDeploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.4.1124.51302",
              "templateHash": "6904951208871566859"
            }
          },
          "parameters": {
            "groupId": {
              "type": "string"
            },
            "name": {
              "type": "string"
            },
            "description": {
              "type": "string"
            },
            "mode": {
              "type": "string",
              "defaultValue": "Indexed"
            }
          },
          "resources": [
            {
              "type": "Microsoft.Authorization/policyDefinitions",
              "apiVersion": "2021-06-01",
              "name": "[parameters('name')]",
              "properties": {
                "description": "[parameters('description')]",
                "displayName": "[parameters('description')]",
                "mode": "[parameters('mode')]",
                "policyRule": {
                  "if": {
                    "allOf": [
                      {
                        "field": "type",
                        "equals": "Microsoft.Network/privateEndpoints"
                      },
                      {
                        "count": {
                          "field": "Microsoft.Network/privateEndpoints/privateLinkServiceConnections[*].groupIds[*]",
                          "where": {
                            "field": "Microsoft.Network/privateEndpoints/privateLinkServiceConnections[*].groupIds[*]",
                            "equals": "[parameters('groupId')]"
                          }
                        },
                        "greaterOrEquals": 1
                      }
                    ]
                  },
                  "then": {
                    "effect": "[[parameters('effect')]",
                    "details": {
                      "type": "Microsoft.Network/privateEndpoints/privateDnsZoneGroups",
                      "evaluationDelay": "AfterProvisioning",
                      "roleDefinitionIds": [
                        "/providers/Microsoft.Authorization/roleDefinitions/4d97b98b-1d4f-4787-a291-c67834d212e7"
                      ],
                      "deployment": {
                        "properties": {
                          "mode": "incremental",
                          "template": {
                            "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                            "contentVersion": "1.0.0.0",
                            "parameters": {
                              "privateDnsZoneId": {
                                "type": "string"
                              },
                              "privateEndpointName": {
                                "type": "string"
                              },
                              "location": {
                                "type": "string"
                              }
                            },
                            "resources": [
                              {
                                "name": "[[concat(parameters('privateEndpointName'), '/deployedByPolicy')]",
                                "type": "Microsoft.Network/privateEndpoints/privateDnsZoneGroups",
                                "apiVersion": "2020-03-01",
                                "location": "[[parameters('location')]",
                                "properties": {
                                  "privateDnsZoneConfigs": [
                                    {
                                      "name": "[format('{0}-Private-DNS', parameters('name'))]",
                                      "properties": {
                                        "privateDnsZoneId": "[[parameters('privateDnsZoneId')]"
                                      }
                                    }
                                  ]
                                }
                              }
                            ]
                          },
                          "parameters": {
                            "privateDnsZoneId": {
                              "value": "[[parameters('privateDnsZoneId')]"
                            },
                            "privateEndpointName": {
                              "value": "[[field('name')]"
                            },
                            "location": {
                              "value": "[[field('location')]"
                            }
                          }
                        }
                      }
                    }
                  }
                },
                "parameters": {
                  "privateDnsZoneId": {
                    "type": "String"
                  },
                  "effect": {
                    "type": "String",
                    "allowedValues": [
                      "DeployIfNotExists",
                      "Disabled"
                    ],
                    "defaultValue": "DeployIfNotExists"
                  }
                }
              }
            }
          ],
          "outputs": {
            "policyId": {
              "type": "string",
              "value": "[extensionResourceId(managementGroup().id, 'Microsoft.Authorization/policyDefinitions', parameters('name'))]"
            }
          }
        }
      },
      "dependsOn": [
        "privateDnsZones"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2020-10-01",
      "name": "pause-for-initiative",
      "location": "[deployment().location]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-08-01/managementGroupDeploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.4.1124.51302",
              "templateHash": "1545203232704064580"
            }
          },
          "parameters": {
            "time": {
              "type": "string",
              "defaultValue": "[utcNow()]"
            }
          },
          "variables": {
            "uniqueName": "[guid(parameters('time'))]"
          },
          "resources": [
            {
              "copy": {
                "name": "delayLoop",
                "count": "[length(range(0, 10))]",
                "mode": "serial",
                "batchSize": 1
              },
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2021-04-01",
              "name": "[format('{0}-{1}', variables('uniqueName'), range(0, 10)[copyIndex()])]",
              "location": "[deployment().location]",
              "properties": {
                "mode": "Incremental",
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-08-01/managementGroupDeploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "parameters": {},
                  "resources": [],
                  "outputs": {}
                }
              }
            }
          ]
        }
      },
      "dependsOn": [
        "[extensionResourceId(managementGroup().id, 'Microsoft.Authorization/policySetDefinitions', 'Private-DNS-PaaS')]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2020-10-01",
      "name": "assign-initiative-DNS",
      "location": "[deployment().location]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "policyAssignmentEnforcementMode": {
            "value": "Default"
          },
          "policyAssignmentName": {
            "value": "Private-DNS-PaaS"
          },
          "policyDescription": {
            "value": "Create DNS record for PaaS services"
          },
          "nonComplianceMessage": {
            "value": "[variables('nonComplianceMessage')]"
          },
          "policyDisplayName": {
            "value": "Create DNS record for PaaS services"
          },
          "policyDefinitionId": {
            "value": "[extensionResourceId(managementGroup().id, 'Microsoft.Authorization/policySetDefinitions', 'Private-DNS-PaaS')]"
          },
          "location": {
            "value": "[parameters('location')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-08-01/managementGroupDeploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.4.1124.51302",
              "templateHash": "16387928720901184567"
            }
          },
          "parameters": {
            "policyAssignmentEnforcementMode": {
              "type": "string",
              "allowedValues": [
                "Default",
                "DoNotEnforce"
              ],
              "metadata": {
                "description": "Input will determine if the policyAssignment should be enforced or not."
              }
            },
            "policyDefinitionId": {
              "type": "string"
            },
            "policyAssignmentName": {
              "type": "string"
            },
            "policyDisplayName": {
              "type": "string"
            },
            "policyDescription": {
              "type": "string"
            },
            "policyParameters": {
              "type": "object",
              "defaultValue": {}
            },
            "exclusions": {
              "type": "array",
              "defaultValue": []
            },
            "nonComplianceMessage": {
              "type": "string"
            },
            "location": {
              "type": "string"
            }
          },
          "resources": [
            {
              "type": "Microsoft.Authorization/policyAssignments",
              "apiVersion": "2020-09-01",
              "name": "[parameters('policyAssignmentName')]",
              "identity": {
                "type": "SystemAssigned"
              },
              "location": "[parameters('location')]",
              "properties": {
                "description": "[parameters('policyDescription')]",
                "displayName": "[parameters('policyDisplayName')]",
                "policyDefinitionId": "[parameters('policyDefinitionId')]",
                "enforcementMode": "[parameters('policyAssignmentEnforcementMode')]",
                "parameters": "[parameters('policyParameters')]",
                "notScopes": "[parameters('exclusions')]",
                "nonComplianceMessages": [
                  {
                    "message": "[parameters('nonComplianceMessage')]"
                  }
                ]
              }
            }
          ],
          "outputs": {
            "policyIdentity": {
              "type": "string",
              "value": "[reference(extensionResourceId(managementGroup().id, 'Microsoft.Authorization/policyAssignments', parameters('policyAssignmentName')), '2020-09-01', 'full').identity.principalId]"
            }
          }
        }
      },
      "dependsOn": [
        "[extensionResourceId(managementGroup().id, 'Microsoft.Authorization/policySetDefinitions', 'Private-DNS-PaaS')]",
        "[extensionResourceId(managementGroup().id, 'Microsoft.Resources/deployments', 'pause-for-initiative')]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2020-10-01",
      "name": "pause-for-assignment",
      "location": "[deployment().location]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-08-01/managementGroupDeploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.4.1124.51302",
              "templateHash": "1545203232704064580"
            }
          },
          "parameters": {
            "time": {
              "type": "string",
              "defaultValue": "[utcNow()]"
            }
          },
          "variables": {
            "uniqueName": "[guid(parameters('time'))]"
          },
          "resources": [
            {
              "copy": {
                "name": "delayLoop",
                "count": "[length(range(0, 10))]",
                "mode": "serial",
                "batchSize": 1
              },
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2021-04-01",
              "name": "[format('{0}-{1}', variables('uniqueName'), range(0, 10)[copyIndex()])]",
              "location": "[deployment().location]",
              "properties": {
                "mode": "Incremental",
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-08-01/managementGroupDeploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "parameters": {},
                  "resources": [],
                  "outputs": {}
                }
              }
            }
          ]
        }
      },
      "dependsOn": [
        "[extensionResourceId(managementGroup().id, 'Microsoft.Resources/deployments', 'assign-initiative-DNS')]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2020-10-01",
      "name": "assign-role-NetworkContributor",
      "location": "[deployment().location]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "assignmentName": {
            "value": "Policy-PrivateDNS"
          },
          "principalId": {
            "value": "[reference(extensionResourceId(managementGroup().id, 'Microsoft.Resources/deployments', 'assign-initiative-DNS'), '2020-10-01').outputs.policyIdentity.value]"
          },
          "roleId": {
            "value": "4d97b98b-1d4f-4787-a291-c67834d212e7"
          },
          "principalType": {
            "value": "ServicePrincipal"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-08-01/managementGroupDeploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.4.1124.51302",
              "templateHash": "11533738661285334134"
            }
          },
          "parameters": {
            "roleId": {
              "type": "string"
            },
            "assignmentName": {
              "type": "string"
            },
            "principalId": {
              "type": "string"
            },
            "principalType": {
              "type": "string",
              "allowedValues": [
                "User",
                "ServicePrincipal",
                "Group",
                "MSI"
              ]
            }
          },
          "resources": [
            {
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2020-08-01-preview",
              "name": "[guid(parameters('roleId'), parameters('assignmentName'))]",
              "properties": {
                "principalType": "[parameters('principalType')]",
                "roleDefinitionId": "[format('/providers/Microsoft.Authorization/roleDefinitions/{0}', parameters('roleId'))]",
                "principalId": "[parameters('principalId')]"
              }
            }
          ],
          "outputs": {
            "roleId": {
              "type": "string",
              "value": "[extensionResourceId(managementGroup().id, 'Microsoft.Authorization/roleAssignments', guid(parameters('roleId'), parameters('assignmentName')))]"
            }
          }
        }
      },
      "dependsOn": [
        "[extensionResourceId(managementGroup().id, 'Microsoft.Resources/deployments', 'assign-initiative-DNS')]",
        "[extensionResourceId(managementGroup().id, 'Microsoft.Resources/deployments', 'pause-for-assignment')]"
      ]
    }
  ]
}