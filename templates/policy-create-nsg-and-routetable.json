{
  "$schema": "https://schema.management.azure.com/schemas/2019-08-01/managementGroupDeploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "_generator": {
      "name": "bicep",
      "version": "0.4.613.9944",
      "templateHash": "7951765094644044941"
    }
  },
  "functions": [],
  "variables": {
    "routes": "[json('[\r\n    {\r\n        \"name\": \"rt-prod-eus-transit\",\r\n        \"location\": \"eastus\",\r\n        \"routename\": \"route-to-regional-firewall\",\r\n        \"properties\": {\r\n            \"nextHopType\": \"VirtualAppliance\",\r\n            \"addressPrefix\": \"0.0.0.0/0\",\r\n            \"nextHopIpAddress\": \"10.100.0.4\"\r\n        }\r\n    },\r\n    {\r\n        \"name\": \"rt-prod-wus-transit\",\r\n        \"location\": \"westus\",\r\n        \"routename\": \"route-to-regional-firewall\",\r\n        \"properties\": {\r\n            \"nextHopType\": \"VirtualAppliance\",\r\n            \"addressPrefix\": \"0.0.0.0/0\",\r\n            \"nextHopIpAddress\": \"10.200.0.4\"\r\n        }\r\n    }\r\n]')]",
    "nsgs": "[json('[\r\n    {\r\n        \"name\": \"nsg-prod-eus-transit\",\r\n        \"location\": \"eastus\"\r\n    },\r\n    {\r\n        \"name\": \"nsg-prod-wus-transit\",\r\n        \"location\": \"westus\"\r\n    }\r\n]')]",
    "tags": "[json('{\r\n    \"Application\": \"Azure Platform Operations\",\r\n    \"Application Owner\": \"Azure Platform Team\",\r\n    \"Cost Center\": \"04152010\",\r\n    \"Contact Email\": \"az-platformops@erickmoore.com\",\r\n    \"Data Classification\": \"Internal\",\r\n    \"Recovery Tier\": \"Tier 2\"\r\n}')]"
  },
  "resources": [
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2019-10-01",
      "name": "createPolicy",
      "location": "[deployment().location]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "description": {
            "value": "Create transit route tables and default NSG"
          },
          "nsgList": {
            "value": "[variables('nsgs')]"
          },
          "policyName": {
            "value": "Create transit route tables and default NSG"
          },
          "resourceGroupName": {
            "value": "rg-prod-global-transit"
          },
          "routeTables": {
            "value": "[variables('routes')]"
          },
          "tags": {
            "value": "[variables('tags')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-08-01/managementGroupDeploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.4.613.9944",
              "templateHash": "330350353223583716"
            }
          },
          "parameters": {
            "mode": {
              "type": "string",
              "defaultValue": "All"
            },
            "description": {
              "type": "string"
            },
            "policyName": {
              "type": "string"
            },
            "tags": {
              "type": "object"
            },
            "resourceGroupName": {
              "type": "string"
            },
            "routeTables": {
              "type": "array"
            },
            "nsgList": {
              "type": "array"
            }
          },
          "functions": [],
          "resources": [
            {
              "type": "Microsoft.Authorization/policyDefinitions",
              "apiVersion": "2020-09-01",
              "name": "[parameters('policyName')]",
              "properties": {
                "description": "[parameters('description')]",
                "displayName": "[parameters('description')]",
                "mode": "[parameters('mode')]",
                "policyRule": {
                  "if": {
                    "allOf": [
                      {
                        "field": "type",
                        "equals": "Microsoft.Resources/subscriptions"
                      }
                    ]
                  },
                  "then": {
                    "effect": "deployIfNotExists",
                    "details": {
                      "deploymentScope": "subscription",
                      "existenceScope": "resourceGroup",
                      "resourceGroupName": "[parameters('resourceGroupName')]",
                      "type": "Microsoft.Network/routeTables",
                      "roleDefinitionIds": [
                        "/providers/microsoft.authorization/roleDefinitions/b24988ac-6180-42a0-ab88-20f7382dd24c"
                      ],
                      "deployment": {
                        "location": "eastus",
                        "properties": {
                          "mode": "incremental",
                          "template": {
                            "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json",
                            "contentVersion": "1.0.0.0",
                            "parameters": {
                              "location": {
                                "type": "string"
                              },
                              "routeTables": {
                                "type": "array"
                              },
                              "nsgList": {
                                "type": "array"
                              }
                            },
                            "resources": [
                              {
                                "name": "[parameters('resourceGroupName')]",
                                "type": "Microsoft.Resources/resourceGroups",
                                "apiVersion": "2021-04-01",
                                "location": "[[parameters('location')]",
                                "dependsOn": [],
                                "tags": "[parameters('tags')]"
                              },
                              {
                                "type": "Microsoft.Resources/deployments",
                                "apiVersion": "2019-10-01",
                                "name": "routeTables",
                                "resourceGroup": "[parameters('resourceGroupName')]",
                                "properties": {
                                  "expressionEvaluationOptions": {
                                    "scope": "inner"
                                  },
                                  "mode": "Incremental",
                                  "parameters": {
                                    "routeTables": {
                                      "value": "[[parameters('routeTables')]"
                                    },
                                    "nsgList": {
                                      "value": "[[parameters('nsgList')]"
                                    }
                                  },
                                  "template": {
                                    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                                    "contentVersion": "1.0.0.0",
                                    "parameters": {
                                      "routeTables": {
                                        "type": "array"
                                      },
                                      "nsgList": {
                                        "type": "array"
                                      }
                                    },
                                    "functions": [],
                                    "resources": [
                                      {
                                        "copy": {
                                          "name": "rt",
                                          "count": "[[length(parameters('routeTables'))]"
                                        },
                                        "type": "Microsoft.Network/routeTables",
                                        "apiVersion": "2021-02-01",
                                        "name": "[[parameters('routeTables')[copyIndex()].name]",
                                        "location": "[[parameters('routeTables')[copyIndex()].location]",
                                        "properties": {
                                          "disableBgpRoutePropagation": true,
                                          "routes": [
                                            {
                                              "name": "[[parameters('routeTables')[copyIndex()].routename]",
                                              "properties": {
                                                "addressPrefix": "[[parameters('routeTables')[copyIndex()].properties.addressPrefix]",
                                                "nextHopIpAddress": "[[parameters('routeTables')[copyIndex()].properties.nextHopIpAddress]",
                                                "nextHopType": "[[parameters('routeTables')[copyIndex()].properties.nextHopType]"
                                              }
                                            }
                                          ]
                                        }
                                      },
                                      {
                                        "copy": {
                                          "name": "nsgs",
                                          "count": "[[length(parameters('nsgList'))]"
                                        },
                                        "type": "Microsoft.Network/networkSecurityGroups",
                                        "apiVersion": "2021-02-01",
                                        "name": "[[parameters('nsgList')[copyIndex()].name]",
                                        "location": "[[parameters('nsgList')[copyIndex()].location]"
                                      }
                                    ]
                                  }
                                },
                                "dependsOn": [
                                  "[parameters('resourceGroupName')]"
                                ]
                              }
                            ]
                          },
                          "parameters": {
                            "routeTables": {
                              "value": "[parameters('routeTables')]"
                            },
                            "nsgList": {
                              "value": "[parameters('nsgList')]"
                            },
                            "location": {
                              "value": "eastus"
                            }
                          }
                        }
                      }
                    }
                  }
                },
                "parameters": {}
              }
            }
          ],
          "outputs": {
            "policyId": {
              "type": "string",
              "value": "[format('Microsoft.Authorization/policyDefinitions/{0}', parameters('policyName'))]"
            }
          }
        }
      }
    }
  ]
}